# 邮件监控系统使用说明

## 系统概述

这是一个自动化的邮件监控系统，可以：
1. 每5分钟自动检查QQ邮箱的新邮件
2. 发现新邮件时自动通过QQ Bot推送通知
3. 支持缓存机制，避免重复通知
4. 记录所有通知历史

## 已安装的组件

### 1. 核心脚本
- `email-monitor.js` - 邮件监控核心，检查新邮件并管理缓存
- `push-to-qqbot.js` - 推送脚本，将新邮件通知格式化输出
- `test-monitor.js` - 测试脚本，验证监控功能

### 2. 配置文件
- `.env` - QQ邮箱的IMAP/SMTP配置
- `email-monitor-cache.json` - 监控缓存（自动生成）
- `email-notified.json` - 已通知邮件记录（自动生成）

### 3. 日志文件
- `logs/cron-push.log` - cron任务执行日志
- `logs/push-log.json` - 推送记录（JSON格式）
- `logs/notifications-text.log` - 通知历史（文本格式）

## 系统状态

✅ **已配置完成：**
- QQ邮箱IMAP连接正常
- 邮件监控脚本工作正常
- Cron任务已设置（每5分钟运行一次）
- 缓存机制已启用

## 使用方法

### 1. 手动检查新邮件
```bash
cd /root/.openclaw/workspace/skills/imap-smtp-email/scripts
node push-to-qqbot.js
```

### 2. 测试监控功能
```bash
cd /root/.openclaw/workspace/skills/imap-smtp-email/scripts
node test-monitor.js
```

### 3. 查看日志
```bash
# 查看cron执行日志
tail -f /root/.openclaw/workspace/skills/imap-smtp-email/scripts/logs/cron-push.log

# 查看通知历史
cat /root/.openclaw/workspace/skills/imap-smtp-email/scripts/logs/notifications-text.log

# 查看推送记录
cat /root/.openclaw/workspace/skills/imap-smtp-email/scripts/logs/push-log.json | jq .
```

### 4. 管理cron任务
```bash
# 查看当前cron任务
crontab -l

# 编辑cron任务
crontab -e

# 删除邮件监控任务
crontab -l | grep -v "邮件监控" | crontab -
```

## 推送机制

### 推送格式
当检测到新邮件时，系统会输出以下格式：
```
[[QQ_BOT_PUSH_START]]
📧 新邮件通知

[邮件详情...]

📅 检查时间: [时间]
[[QQ_BOT_PUSH_END]]
```

### 推送内容
每条通知包含：
- 新邮件数量
- 每封邮件的：主题、发件人、时间、内容摘要
- 检查时间

## 缓存机制

### 1. 时间缓存
- 记录最后检查时间
- 只检查自上次检查以来的新邮件

### 2. 邮件ID缓存
- 记录已通知的邮件UID
- 避免重复通知同一封邮件
- 自动清理旧记录（只保留最近100条）

### 3. 重置缓存
如果需要重新检查所有邮件，可以删除缓存文件：
```bash
rm -f /root/.openclaw/workspace/skills/imap-smtp-email/scripts/email-monitor-cache.json
rm -f /root/.openclaw/workspace/skills/imap-smtp-email/scripts/email-notified.json
```

## 故障排除

### 常见问题

#### 1. 认证失败
```
Error: No supported authentication method(s) available.
```
**解决方案：**
- 检查`.env`文件中的`IMAP_PASS`是否正确
- 确认QQ邮箱已开启IMAP服务
- 确认使用的是16位授权码，不是QQ密码

#### 2. 连接超时
```
Error: Connection timeout
```
**解决方案：**
- 检查网络连接
- 确认IMAP服务器地址正确（imap.qq.com:993）
- 增加超时时间（修改脚本中的`authTimeout`）

#### 3. 没有收到通知
**检查步骤：**
1. 查看cron日志：`tail -f logs/cron-push.log`
2. 手动运行测试：`node test-monitor.js`
3. 检查缓存文件是否存在
4. 确认cron任务正常运行：`crontab -l`

### 日志分析
```bash
# 查看最近10条cron日志
tail -n 10 logs/cron-push.log

# 查看错误信息
grep -i error logs/cron-push.log

# 查看成功通知
grep "QQ_BOT_PUSH_START" logs/cron-push.log
```

## 性能优化

### 1. 检查频率
- 当前：每5分钟
- 可调整：修改cron表达式
  - `*/10 * * * *` - 每10分钟
  - `*/30 * * * *` - 每30分钟
  - `0 * * * *` - 每小时

### 2. 邮件数量限制
- 默认：检查所有新邮件
- 可调整：修改`email-monitor.js`中的搜索条件

### 3. 摘要长度
- 默认：前200字符
- 可调整：修改`email-monitor.js`中的`snippet`生成逻辑

## 安全注意事项

1. **授权码安全**：`.env`文件包含QQ邮箱授权码，请勿泄露
2. **缓存清理**：定期检查缓存文件大小
3. **日志管理**：日志文件可能包含邮件内容，注意隐私保护
4. **网络安全**：确保服务器安全，避免未授权访问

## 扩展功能

### 1. 添加邮件过滤
可以修改`email-monitor.js`，添加发件人过滤、关键词过滤等功能

### 2. 多邮箱支持
可以扩展支持多个邮箱账户的监控

### 3. 高级通知
可以集成其他通知渠道（微信、钉钉、Telegram等）

### 4. 邮件分类
可以根据发件人、主题等对邮件进行分类处理

---

## 最后测试

运行以下命令验证系统完整性：
```bash
cd /root/.openclaw/workspace/skills/imap-smtp-email/scripts

# 测试1：验证脚本权限
ls -la *.js

# 测试2：验证环境配置
node -e "require('dotenv').config(); console.log('IMAP_USER:', process.env.IMAP_USER || '未设置')"

# 测试3：运行完整测试
./test-monitor.js

# 测试4：验证推送功能
./push-to-qqbot.js
```

如果所有测试通过，系统已准备就绪！🎉

---
*系统配置时间：2026年2月26日*
*最后更新：2026年2月26日*